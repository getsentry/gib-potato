name: "PHP CI"

on:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - '*'

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, intl
    
    - name: Run composer install
      run: composer update --no-progress

    - name: Run PHP CodeSniffer
      run: vendor/bin/phpcs --colors -p  src/ tests/
    
    - name: Run PHPStan
      run: vendor/bin/phpstan analyse

    - name: Setup PostgreSQL
      run: docker run --rm --name=postgres -e POSTGRES_DB=gib_potato_test -e POSTGRES_USER=gib_potato -e POSTGRES_PASSWORD=password -p 5432:5432 -d postgres:14

    - name: Wait for PostgreSQL
      run: while ! `pg_isready -U gib_potato`; sleep 2;
    
    - name: Run PHPUnit
      run: |
        export CODECOVERAGE=1
        vendor/bin/phpunit --verbose --colors=always --coverage-clover=coverage.xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
